<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Histórico de Leituras</title>
  
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="css/style.css">
</head>
<body>
  <nav class="navbar navbar-dark bg-success">
    <div class="container">
      <a class="navbar-brand" href="#" onclick="history.back()">
        <i class="fas fa-arrow-left"></i> Voltar
      </a>
      <span class="navbar-text text-white">Histórico de Leituras</span>
    </div>
  </nav>

  <div class="container my-4">
    <div class="card">
      <div class="card-header">
        <h5 class="mb-0"><i class="fas fa-chart-line"></i> Umidade do Solo - Últimas 24h</h5>
      </div>
      <div class="card-body">
        <canvas id="moistureChart" height="80"></canvas>
      </div>
    </div>

    <div class="card mt-4">
      <div class="card-header">
        <h5 class="mb-0"><i class="fas fa-list"></i> Últimas Leituras</h5>
      </div>
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-striped">
            <thead>
              <tr>
                <th>Data/Hora</th>
                <th>Umidade (%)</th>
                <th>Válvula</th>
                <th>Threshold</th>
              </tr>
            </thead>
            <tbody id="historyTable"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <script src="config.js"></script>
  <script src="js/api.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  
  <script>
    const urlParams = new URLSearchParams(window.location.search)
    const deviceId = urlParams.get('id')
    let chart = null

    async function loadHistory() {
      try {
        const data = await API.getHistory(deviceId, { limit: 100 })
        const readings = data.readings.reverse() // Ordem cronológica
        
        renderChart(readings)
        renderTable(readings)
      } catch (error) {
        alert('Erro ao carregar histórico: ' + error.message)
      }
    }

    function renderChart(readings) {
      const ctx = document.getElementById('moistureChart').getContext('2d')
      
      const labels = readings.map(r => {
        const date = new Date(r.timestamp)
        return date.toLocaleString('pt-BR', { 
          day: '2-digit', 
          month: '2-digit', 
          hour: '2-digit', 
          minute: '2-digit' 
        })
      })
      
      const moistureData = readings.map(r => r.soil_moisture)
      const thresholdData = readings.map(r => r.threshold || 30)
      
      chart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [
            {
              label: 'Umidade do Solo',
              data: moistureData,
              borderColor: 'rgb(75, 192, 192)',
              backgroundColor: 'rgba(75, 192, 192, 0.2)',
              tension: 0.4
            },
            {
              label: 'Threshold',
              data: thresholdData,
              borderColor: 'rgb(255, 99, 132)',
              borderDash: [5, 5],
              fill: false,
              tension: 0
            }
          ]
        },
        options: {
          responsive: true,
          interaction: {
            mode: 'index',
            intersect: false,
          },
          plugins: {
            legend: {
              position: 'top',
            },
            title: {
              display: false
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              max: 100,
              title: {
                display: true,
                text: 'Umidade (%)'
              }
            }
          }
        }
      })
    }

    function renderTable(readings) {
      const tbody = document.getElementById('historyTable')
      
      tbody.innerHTML = readings.slice(0, 20).map(reading => {
        const date = new Date(reading.timestamp)
        return `
          <tr>
            <td>${date.toLocaleString('pt-BR')}</td>
            <td><strong>${reading.soil_moisture.toFixed(1)}%</strong></td>
            <td>
              <span class="badge ${reading.valve_state === 'OPEN' ? 'bg-primary' : 'bg-secondary'}">
                ${reading.valve_state}
              </span>
            </td>
            <td>${reading.threshold || '--'}%</td>
          </tr>
        `
      }).join('')
    }

    loadHistory()
  </script>
</body>
</html>
