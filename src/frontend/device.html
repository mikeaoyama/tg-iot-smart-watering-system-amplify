<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Detalhes do Dispositivo</title>
  
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="css/style.css">
</head>
<body>
  <nav class="navbar navbar-dark bg-success">
    <div class="container">
      <a class="navbar-brand" href="index.html">
        <i class="fas fa-arrow-left"></i> Voltar
      </a>
      <span class="navbar-text text-white" id="deviceTitle">Carregando...</span>
    </div>
  </nav>

  <div class="container my-4">
    <!-- Status em Tempo Real -->
    <div class="card mb-4">
      <div class="card-header bg-success text-white">
        <h5 class="mb-0"><i class="fas fa-chart-line"></i> Status em Tempo Real</h5>
      </div>
      <div class="card-body">
        <div id="statusLoading" class="text-center">
          <div class="spinner-border text-success" role="status"></div>
        </div>
        
        <div id="statusContent" style="display: none;">
          <div class="row text-center">
            <div class="col-md-4">
              <div class="p-3 border rounded">
                <i class="fas fa-tint fa-3x text-info mb-2"></i>
                <h3 id="moisture" class="mb-0">--</h3>
                <p class="text-muted">Umidade do Solo (%)</p>
              </div>
            </div>
            <div class="col-md-4">
              <div class="p-3 border rounded">
                <i class="fas fa-faucet fa-3x text-primary mb-2"></i>
                <h3 id="valveState" class="mb-0">--</h3>
                <p class="text-muted">Estado da Válvula</p>
              </div>
            </div>
            <div class="col-md-4">
              <div class="p-3 border rounded">
                <i class="fas fa-crosshairs fa-3x text-warning mb-2"></i>
                <h3 id="threshold" class="mb-0">--</h3>
                <p class="text-muted">Threshold (%)</p>
              </div>
            </div>
          </div>
          
          <div class="text-muted text-center mt-3">
            <small>Última atualização: <span id="lastUpdate">--</span></small>
          </div>
        </div>

        <div id="statusError" style="display: none;" class="alert alert-warning">
          <i class="fas fa-exclamation-triangle"></i> Nenhum dado disponível ainda. Aguardando leituras do sensor...
        </div>
      </div>
    </div>

    <!-- Controle Manual -->
    <div class="row mb-4">
      <div class="col-md-6">
        <div class="card h-100">
          <div class="card-header">
            <h5 class="mb-0"><i class="fas fa-sliders-h"></i> Controle de Threshold</h5>
          </div>
          <div class="card-body">
            <label class="form-label">Threshold de Umidade (%)</label>
            <input type="range" class="form-range" id="thresholdSlider" min="0" max="100" value="30">
            <div class="d-flex justify-content-between">
              <span>0%</span>
              <span id="thresholdValue" class="fw-bold">30%</span>
              <span>100%</span>
            </div>
            <button 
              class="btn btn-success w-100 mt-3" 
              id="applyThresholdBtn" 
              onclick="updateThreshold()" 
              disabled>
              <i class="fas fa-save"></i> Atualizar Threshold
            </button>
            <small class="text-muted d-block mt-2">
              <i class="fas fa-info-circle"></i> Altere o valor acima para habilitar o botão
            </small>
          </div>
        </div>
      </div>

      <div class="col-md-6">
        <div class="card h-100">
          <div class="card-header">
            <h5 class="mb-0"><i class="fas fa-hand-paper"></i> Controle Manual</h5>
          </div>
          <div class="card-body">
            <!-- Status Atual da Válvula -->
            <div class="alert alert-info mb-3" id="valveStatusAlert">
              <div class="d-flex align-items-center">
                <i class="fas fa-faucet fa-2x me-3"></i>
                <div>
                  <strong>Status Atual:</strong>
                  <h4 class="mb-0 mt-1">
                    <span class="badge bg-secondary" id="currentValveState">--</span>
                  </h4>
                </div>
              </div>
            </div>

            <p class="text-muted small">Abrir/fechar válvula manualmente (desativa modo automático)</p>
            <div class="d-grid gap-2">
              <button class="btn btn-primary btn-lg" onclick="controlValve('OPEN')" id="openValveBtn">
                <i class="fas fa-unlock"></i> Abrir Válvula
              </button>
              <button class="btn btn-secondary btn-lg" onclick="controlValve('CLOSED')" id="closeValveBtn">
                <i class="fas fa-lock"></i> Fechar Válvula
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Ações -->
    <div class="card mb-4">
      <div class="card-header">
        <h5 class="mb-0"><i class="fas fa-cog"></i> Ações</h5>
      </div>
      <div class="card-body">
        <div class="row g-3">
          <div class="col-md-4">
            <button class="btn btn-info w-100" onclick="viewHistory()">
              <i class="fas fa-chart-area"></i> Ver Histórico
            </button>
          </div>
          <div class="col-md-4">
            <button class="btn btn-warning w-100" data-bs-toggle="modal" data-bs-target="#editModal">
              <i class="fas fa-edit"></i> Editar Dispositivo
            </button>
          </div>
          <div class="col-md-4">
            <button class="btn btn-danger w-100" onclick="confirmDelete()">
              <i class="fas fa-trash"></i> Excluir Dispositivo
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal: Editar -->
  <div class="modal fade" id="editModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Editar Dispositivo</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="editForm">
            <div class="mb-3">
              <label class="form-label">Nome</label>
              <input type="text" class="form-control" name="device_name" id="editName">
            </div>
            <div class="mb-3">
              <label class="form-label">Localização</label>
              <input type="text" class="form-control" name="location" id="editLocation">
            </div>
            <div class="mb-3">
              <label class="form-label">Status</label>
              <select class="form-select" name="status" id="editStatus">
                <option value="active">Ativo</option>
                <option value="inactive">Inativo</option>
              </select>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="button" class="btn btn-warning" onclick="saveEdit()">Salvar</button>
        </div>
      </div>
    </div>
  </div>

  <script src="config.js"></script>
  <script src="js/api.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  
  <script>
    const urlParams = new URLSearchParams(window.location.search)
    const deviceId = urlParams.get('id')
    let device = null
    let statusInterval = null
    let originalThreshold = 30 // Armazena threshold original
    let currentValveState = null // Armazena estado atual da válvula

    async function loadDevice() {
      try {
        device = await API.getDevice(deviceId)
        document.getElementById('deviceTitle').textContent = device.device_name
        
        // Pegar threshold do shadow (se existir)
        if (device.shadow && device.shadow.desired && device.shadow.desired.threshold) {
          originalThreshold = device.shadow.desired.threshold
        } else if (device.configuration && device.configuration.threshold) {
          originalThreshold = device.configuration.threshold
        }
        
        // Atualizar slider com threshold atual
        const slider = document.getElementById('thresholdSlider')
        slider.value = originalThreshold
        document.getElementById('thresholdValue').textContent = originalThreshold + '%'
        
        // Preencher form de edição
        document.getElementById('editName').value = device.device_name
        document.getElementById('editLocation').value = device.location || ''
        document.getElementById('editStatus').value = device.status
        
        loadStatus()
        // Atualizar a cada 10 segundos
        statusInterval = setInterval(loadStatus, 10000)
      } catch (error) {
        alert('Erro ao carregar dispositivo: ' + error.message)
        window.location.href = 'index.html'
      }
    }

    async function loadStatus() {
      const loading = document.getElementById('statusLoading')
      const content = document.getElementById('statusContent')
      const error = document.getElementById('statusError')
      
      try {
        const status = await API.getStatus(deviceId)
        const reading = status.current_status
        
        // Atualizar cards de status
        document.getElementById('moisture').textContent = reading.soil_moisture.toFixed(1)
        document.getElementById('valveState').textContent = reading.valve_state
        document.getElementById('threshold').textContent = reading.threshold || '--'
        
        const date = new Date(reading.timestamp)
        document.getElementById('lastUpdate').textContent = date.toLocaleString('pt-BR')
        
        // Atualizar status da válvula no controle manual
        currentValveState = reading.valve_state
        updateValveStatusDisplay(reading.valve_state)
        
        loading.style.display = 'none'
        content.style.display = 'block'
        error.style.display = 'none'
      } catch (err) {
        loading.style.display = 'none'
        content.style.display = 'none'
        error.style.display = 'block'
      }
    }

    // Atualizar display do status da válvula
    function updateValveStatusDisplay(state) {
      const badge = document.getElementById('currentValveState')
      const alert = document.getElementById('valveStatusAlert')
      const openBtn = document.getElementById('openValveBtn')
      const closeBtn = document.getElementById('closeValveBtn')
      
      if (state === 'OPEN') {
        badge.textContent = 'ABERTA'
        badge.className = 'badge bg-primary'
        alert.className = 'alert alert-primary mb-3'
        
        // Desabilitar botão "Abrir" se já estiver aberta
        openBtn.disabled = true
        closeBtn.disabled = false
      } else {
        badge.textContent = 'FECHADA'
        badge.className = 'badge bg-secondary'
        alert.className = 'alert alert-secondary mb-3'
        
        // Desabilitar botão "Fechar" se já estiver fechada
        openBtn.disabled = false
        closeBtn.disabled = true
      }
    }

    // Slider de threshold com detecção de mudança
    const slider = document.getElementById('thresholdSlider')
    const valueDisplay = document.getElementById('thresholdValue')
    const applyBtn = document.getElementById('applyThresholdBtn')
    
    slider.addEventListener('input', (e) => {
      const newValue = parseInt(e.target.value)
      valueDisplay.textContent = newValue + '%'
      
      // Habilitar botão apenas se o valor mudou
      if (newValue !== originalThreshold) {
        applyBtn.disabled = false
        applyBtn.classList.remove('btn-success')
        applyBtn.classList.add('btn-warning')
      } else {
        applyBtn.disabled = true
        applyBtn.classList.remove('btn-warning')
        applyBtn.classList.add('btn-success')
      }
    })

    async function updateThreshold() {
      const value = parseInt(slider.value)
      
      try {
        applyBtn.disabled = true
        applyBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Aplicando...'
        
        await API.controlDevice(deviceId, {
          threshold: value,
          auto_mode: true
        })
        
        originalThreshold = value // Atualizar threshold original
        applyBtn.innerHTML = '<i class="fas fa-check"></i> Atualizado!'
        applyBtn.classList.remove('btn-warning')
        applyBtn.classList.add('btn-success')
        
        setTimeout(() => {
          applyBtn.innerHTML = '<i class="fas fa-save"></i> Atualizar Threshold'
          applyBtn.disabled = true
        }, 2000)
        
        loadStatus()
      } catch (error) {
        applyBtn.innerHTML = '<i class="fas fa-save"></i> Atualizar Threshold'
        applyBtn.disabled = false
        alert('Erro ao atualizar threshold: ' + error.message)
      }
    }

    async function controlValve(state) {
      const action = state === 'OPEN' ? 'abrir' : 'fechar'
      if (!confirm(`Deseja ${action} a válvula manualmente?\n\nIsso desativará o modo automático.`)) return
      
      const btnId = state === 'OPEN' ? 'openValveBtn' : 'closeValveBtn'
      const btn = document.getElementById(btnId)
      const originalText = btn.innerHTML
      
      try {
        btn.disabled = true
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Enviando...'
        
        await API.controlDevice(deviceId, {
          valve_override: state,
          auto_mode: false
        })
        
        btn.innerHTML = '<i class="fas fa-check"></i> Comando enviado!'
        
        setTimeout(() => {
          btn.innerHTML = originalText
          loadStatus()
        }, 2000)
        
      } catch (error) {
        btn.innerHTML = originalText
        btn.disabled = false
        alert('Erro ao controlar válvula: ' + error.message)
      }
    }

    async function saveEdit() {
      const form = document.getElementById('editForm')
      const formData = new FormData(form)
      
      const payload = {
        device_name: formData.get('device_name'),
        location: formData.get('location'),
        status: formData.get('status')
      }
      
      try {
        await API.updateDevice(deviceId, payload)
        alert('Dispositivo atualizado!')
        
        const modal = bootstrap.Modal.getInstance(document.getElementById('editModal'))
        modal.hide()
        
        loadDevice()
      } catch (error) {
        alert('Erro ao atualizar: ' + error.message)
      }
    }

    async function confirmDelete() {
      if (!confirm('Tem certeza que deseja excluir este dispositivo? Esta ação não pode ser desfeita!')) return
      
      try {
        await API.deleteDevice(deviceId)
        alert('Dispositivo excluído com sucesso!')
        window.location.href = 'index.html'
      } catch (error) {
        alert('Erro ao excluir: ' + error.message)
      }
    }

    function viewHistory() {
      window.location.href = `history.html?id=${deviceId}`
    }

    // Limpar interval ao sair da página
    window.addEventListener('beforeunload', () => {
      if (statusInterval) clearInterval(statusInterval)
    })

    loadDevice()
  </script>
</body>
</html>
